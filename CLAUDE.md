# Databricks SDK for Go

Go SDK for the Databricks platform. Auto-generated API clients from OpenAPI specs,
with hand-written authentication, configuration, and transport infrastructure.

## Development

Prerequisites: Go 1.22+, `goimports`, `staticcheck`, `gotestsum`.

```bash
make build      # go build ./...
make test       # Unit tests with coverage
make fmt        # goimports + gofmt
make lint       # staticcheck ./...
make integration # Integration tests (requires cloud env)
make vendor     # Vendor dependencies
make coverage   # View HTML coverage report
make codegen    # Regenerate service/ from OpenAPI specs
```

CI runs `go build`, `go vet`, `staticcheck`, and `make test` across Go 1.22, 1.23, and 1.24.

## Architecture

```
├── apierr/         # API error types and handling
├── client/         # High-level DatabricksClient (wraps workspace + account APIs)
├── config/         # Authentication and client configuration (core, hand-written)
├── credentials/    # Credential providers (OAuth, PAT, Azure, GCP, etc.)
├── experimental/   # Experimental features and generated mocks
├── httpclient/     # HTTP transport layer, request/response handling
├── internal/       # Internal utilities
├── listing/        # Iterator patterns for paginated API responses
├── logger/         # Logging infrastructure
├── marshal/        # JSON marshalling utilities
├── openapi/        # Code generator (reads OpenAPI specs, generates service/)
├── retries/        # Retry logic and policies
├── service/        # Auto-generated API service clients (DO NOT EDIT)
├── useragent/      # User-agent string construction
├── .codegen/       # Code generation templates (.tmpl files)
└── qa/             # Integration test helpers (RandomName, RandomEmail, etc.)
```

## Generated Code

**DO NOT manually edit files in these directories — they are auto-generated:**

- `service/` — API service clients, generated from OpenAPI specs.
  Every file starts with `// Code generated from OpenAPI specs by Databricks SDK Generator. DO NOT EDIT.`
- `experimental/mocks/` — Mock implementations, generated by mockery.
  Every file starts with `// Code generated by mockery. DO NOT EDIT.`

To regenerate: `make codegen` (requires OpenAPI specs).
After regenerating, run `make fmt` and `make lint`.

**Hand-written code** lives in: `config/`, `credentials/`, `httpclient/`, `apierr/`,
`listing/`, `retries/`, `marshal/`, `logger/`, `useragent/`, `client/`, `internal/`, `openapi/`.

## Code Style

- Go 1.22+ idioms: range-over-int, `min`/`max` builtins
- Format with `goimports` (handles import grouping) then `gofmt`
- All exported functions and types need doc comments: `// FuncName does X.`
- Error wrapping with context: `fmt.Errorf("failed to create cluster %s: %w", name, err)`
- Return early on errors; avoid deeply nested if-else chains
- Use `context.Context` as the first parameter for functions that do I/O

## Testing

Per the [DECO Go Style Guide](https://databricks.atlassian.net/wiki/spaces/UN/pages/4719935836),
`testify` is **discouraged in new packages** and **tolerated in existing packages**.
The SDK aims to minimize third-party dependencies.

- **New packages**: use Go's standard `testing` package with `google/go-cmp` for complex comparisons
- **Existing packages that already use testify**: keep using it for consistency within that package
- Do NOT introduce testify into a package that doesn't already use it

Table-driven tests are preferred for API client methods:

```go
for _, tc := range testCases {
    t.Run(tc.name, func(t *testing.T) {
        // ...
        if diff := cmp.Diff(tc.expected, actual); diff != "" {
            t.Errorf("mismatch (-want +got):\n%s", diff)
        }
    })
}
```

- Unit tests: `*_test.go` alongside source files
- Integration tests: use `//go:build cloud` build tag
- HTTP fixtures: `httpclient/fixtures/` for mocking HTTP responses
- Generated mocks: `experimental/mocks/` (do not hand-write mocks for generated services)
- Test helpers: `qa/` package for integration test utilities

### Testing Anti-Patterns (never do these)

- Deleting or skipping flaky tests instead of fixing the root cause
- Over-mocking — prefer HTTP fixtures over deep mock chains
- Tests depending on execution order or shared mutable state
- Non-descriptive test names (`TestFoo`, `TestBasic`) — use `TestFunctionName_Scenario_ExpectedBehavior`
- Sleeping instead of waiting for conditions (`assert.Eventually` over `time.Sleep`)
- Testing generated code in `service/` — test your hand-written code that uses it

## Common Mistakes

- Do NOT edit files in `service/` or `experimental/mocks/` — they are auto-generated and will be overwritten
- Do NOT use `context.Background()` in production code (only in tests)
- Do NOT add new files to `service/` manually — update OpenAPI specs and run `make codegen`
- Do NOT add dependencies without checking license compatibility (Apache 2.0 required)
- Do NOT break backwards compatibility of exported APIs without discussion
- Do NOT use `os.Exit()` outside of `main.go` entry points

## Where to Put New Code

1. New API service client? → Update OpenAPI spec, run `make codegen`
2. New auth method? → `credentials/` (implement `CredentialsProvider` interface)
3. Auth config change? → `config/`
4. HTTP transport change? → `httpclient/`
5. New error type? → `apierr/`
6. New pagination pattern? → `listing/`
7. Retry logic change? → `retries/`
8. Code generation change? → `openapi/` and `.codegen/` templates

## Pull Requests

PR template requires: Changes (linked issues + functionality) and Tests sections.
All PRs must have the `DCO` sign-off (`git commit -s`).
Run `make fmt test lint` before submitting.
